---
title: "Final project LM part"
author: "Xinran Yu"
date: '2022-12-02'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#extract top200 
library("dplyr")
times_raw <- read.csv("/Users/yuxinran/Desktop/STA141A/Final Project/timesData.csv")
attach(times_raw)
times_200 <- filter(times_raw,total_score !="-")
detach(times_raw)
attach(times_200) 

```
```{r}
#change the data type to the numeric form
times_200$international <- as.numeric(times_200$international)
times_200$income <- as.numeric(times_200$income)
times_200$total_score <- as.numeric(times_200$total_score)
times_200$num_students <- as.numeric(gsub(",","",times_200$num_students))
times_200$international_students = as.numeric(gsub(".*?([0-9]+).*", "\\1", times_200$international_students))   
times_200$female_male_ratio[times_200$female_male_ratio ==""] =NA
times_200 <- na.omit(times_200)
TEM_FM = as.numeric(unlist(regmatches(times_200$female_male_ratio, gregexpr("[[:digit:]]+", times_200$female_male_ratio))))
FM_matix <- matrix(TEM_FM, nc = 2, byrow = T)
FD_df <- as.data.frame(FM_matix)
FD_df  = FD_df %>% mutate(female_male_ratio = V1/V2)
times_200$female_male_ratio = FD_df$female_male_ratio
```

#regression part
```{r}
library('ggplot2')
library('tidyr')
library("GGally")
ggplot(times_200,aes(total_score))+
  geom_histogram(mapping = aes(y = ..density..),bins = 50)
mean(times_200$total_score)
var(times_200$total_score)
ggplot(pivot_longer(times_200, c(4:8,10:14)), aes(value, total_score)) + 
    theme_minimal() + geom_point() + facet_wrap('name', scales = 'free')
```
According to the graph and the data, the distribution of total score is not Poisson distributed or binary distributed. Besides ,although several variables has non-linear relation to the total score, transformed linear regression model may be appropriate.
#correlations
```{r}
#correlations
times_200_numv <- times_200[c(4:8,10:14)]
as.data.frame(cor(times_200_numv))
```
#transformation
```{r}
ggplot(pivot_longer(times_200, c(4:8,10:14)), aes(value, log(total_score))) + 
    theme_minimal() + geom_point() + facet_wrap('name', scales = 'free')
```

```{r}
lm_full <- lm(log(total_score)~. - world_rank- university_name , data = times_200)
summary(lm_full)
```


As we can see, some of the predictors are not significant. there is high correlation between teaching and research. We  try to find a reduce model.
```{r}
#remove insignificant variables:teaching
lm_redu <- lm(log(total_score)~.-teaching - world_rank- university_name , data = times_200)
anova(lm_full,lm_redu)
```
There is significant difference,thus we should include teaching.
```{r}
#remove insignificant variables:research
lm_redu <- lm(log(total_score)~.-research - world_rank- university_name , data = times_200)
anova(lm_full,lm_redu)
```
There is significant difference,thus we should include research.
```{r}
#remove insignificant variables:num_students,student_staff_ratio,international_students,year
lm_redu1 <- lm(log(total_score)~.-num_students -student_staff_ratio-international_students-year- world_rank- university_name , data = times_200)
anova(lm_full,lm_redu1)
```
There is no significant difference,this model is appropriate.
#AIC
```{r}
AIC(lm_full)
AIC(lm_redu)
AIC(lm_redu1)
```
The AIC result support our decision.

#test violations
```{r}
par(mfrow = c(2, 2))
plot_vio <- plot(lm_redu1)
plot_vio
```
As we can see from the plots, some outliers and high-leverage point need to be removed.
```{r}

```




```{r}
#correlation between income and total score
times_income_remove <- times_200 [,8:9]
times_income_remove$income[times_income_remove$income =="-"] =NA
times_income_remove <- na.omit(times_income_remove)
times_income_remove$total_score <- as.numeric(times_income_remove$total_score)
times_income_remove$income <- as.numeric(times_income_remove$income)
cor(times_income_remove$income,times_income_remove$total_score)
```

